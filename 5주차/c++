#include <iostream>
#include <vector>
#include <ctime>
#include <cstdlib>
#include <windows.h>
#include <iomanip>
#include <string>
#include <sstream>

using namespace std;

const string UNOPENED = "â–¡";
const string MINE = "*";
const string FLAG = "âš‘";

int dx[] = { -1, -1, -1, 0, 1, 1, 1, 0 };
int dy[] = { -1, 0, 1, 1, 1, 0, -1, -1 };

void setupConsole() {
    SetConsoleOutputCP(65001);
    SetConsoleCP(65001);
}

void printMap(const vector<vector<string>>& display) {
    int height = display.size();
    int width = display[0].size();

    cout << "\n   ";
    for (int j = 0; j < width; ++j)
        cout << setw(3) << j;
    cout << endl;

    for (int i = 0; i < height; ++i) {
        cout << setw(3) << i;
        for (int j = 0; j < width; ++j)
            cout << setw(3) << display[i][j];
        cout << endl;
    }
}

int countAdjacentMines(int x, int y, const vector<vector<string>>& map) {
    int count = 0;
    int height = map.size();
    int width = map[0].size();

    for (int d = 0; d < 8; ++d) {
        int nx = x + dx[d];
        int ny = y + dy[d];
        if (nx >= 0 && nx < height && ny >= 0 && ny < width) {
            if (map[nx][ny] == MINE)
                count++;
        }
    }
    return count;
}

void placeMines(vector<vector<string>>& map, int numMines) {
    int height = map.size();
    int width = map[0].size();
    srand((unsigned int)time(0));

    int placed = 0;
    while (placed < numMines) {
        int x = rand() % height;
        int y = rand() % width;
        if (map[x][y] != MINE) {
            map[x][y] = MINE;
            placed++;
        }
    }
}

int main() {
    setupConsole();

    int width, height, numMines;
    cout << "ì§€ë¢°ë§µì˜ ê°€ë¡œ í¬ê¸°(ìµœëŒ€ 80): ";
    cin >> width;
    cout << "ì§€ë¢°ë§µì˜ ì„¸ë¡œ í¬ê¸°(ìµœëŒ€ 40): ";
    cin >> height;
    cout << "ë§¤ì„¤í•  ì§€ë¢°ì˜ ê°œìˆ˜: ";
    cin >> numMines;

    cout << "\nì„¤ì • ì™„ë£Œ! " << width << "x" << height << " ë§µì— ì§€ë¢° " << numMines << "ê°œë¥¼ ë§¤ì„¤í•©ë‹ˆë‹¤.\n";

    vector<vector<string>> map(height, vector<string>(width, " "));
    vector<vector<string>> display(height, vector<string>(width, UNOPENED));
    vector<vector<bool>> opened(height, vector<bool>(width, false));
    vector<vector<bool>> flagged(height, vector<bool>(width, false));

    placeMines(map, numMines);

    for (int i = 0; i < height; ++i)
        for (int j = 0; j < width; ++j)
            if (map[i][j] != MINE)
                map[i][j] = to_string(countAdjacentMines(i, j, map));

    int safeCells = width * height - numMines;
    int openedCount = 0;

    cin.ignore();  // ì¤„ë°”ê¿ˆ ì²˜ë¦¬

    while (true) {
        printMap(display);
        cout << "\nì¢Œí‘œë¥¼ ìž…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì—´ í–‰ or p ì—´ í–‰): ";

        string inputLine;
        getline(cin, inputLine);
        istringstream iss(inputLine);

        string token;
        iss >> token;

        bool flagMode = false;
        int x, y;

        if (token == "p") {
            flagMode = true;
            iss >> x >> y;
        } else {
            x = stoi(token);
            iss >> y;
        }

        if (x < 0 || x >= width || y < 0 || y >= height) {
            cout << "â— ìž˜ëª»ëœ ì¢Œí‘œìž…ë‹ˆë‹¤. ë‹¤ì‹œ ìž…ë ¥í•˜ì„¸ìš”.\n";
            continue;
        }

        if (flagMode) {
            if (opened[y][x]) {
                cout << "âš ï¸ ì´ë¯¸ ì—´ë¦° ì¹¸ì—ëŠ” ê¹ƒë°œì„ ê½‚ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n";
                continue;
            }
            flagged[y][x] = !flagged[y][x];
            display[y][x] = flagged[y][x] ? FLAG : UNOPENED;
            continue;
        }

        if (opened[y][x]) {
            cout << "âš ï¸ ì´ë¯¸ ì—´ë¦° ì¹¸ìž…ë‹ˆë‹¤.\n";
            continue;
        }

        if (flagged[y][x]) {
            cout << "âš ï¸ ê¹ƒë°œì´ ê½‚ížŒ ì¹¸ìž…ë‹ˆë‹¤. ë¨¼ì € ê¹ƒë°œì„ í•´ì œí•˜ì„¸ìš”.\n";
            continue;
        }

        opened[y][x] = true;

        if (map[y][x] == MINE) {
            cout << "\nðŸ’¥ ì§€ë¢°ë¥¼ ë°Ÿì•˜ìŠµë‹ˆë‹¤! ê²Œìž„ ì˜¤ë²„!\n";
            for (int i = 0; i < height; ++i)
                for (int j = 0; j < width; ++j)
                    if (map[i][j] == MINE)
                        display[i][j] = MINE;
            printMap(display);
            break;
        } else {
            display[y][x] = map[y][x];
            openedCount++;
            if (openedCount == safeCells) {
                cout << "\nðŸŽ‰ ëª¨ë“  ì•ˆì „í•œ ì¹¸ì„ ì—´ì—ˆìŠµë‹ˆë‹¤! ìŠ¹ë¦¬!\n";
                printMap(display);
                break;
            }
        }
    }

    return 0;
}
